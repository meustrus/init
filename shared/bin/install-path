#!/bin/sh

INIT_REPO=${INIT_REPO:-$(cd "$(dirname "$0")/../.." && pwd)}
source "$INIT_REPO/shared/vars.sh"

PathDelim=$(( printf '%s' "$OSTYPE" | grep -q msys 2>/dev/null ) && printf ':' || printf ';')
NewPaths=

while IFS=': ' read -r NewPath || [ -n "$NewPath" ]; do
    NewPath=$(cd "$(dirname "$NewPath")" && pwd)/$(basename "$NewPath")
    export PATH="$NewPath:$PATH"
    NewPaths=${NewPaths:+$NewPaths$PathDelim}$NewPath
done << EOF
$*
EOF

if printf '%s' "$OSTYPE" | grep -q msys 2>/dev/null; then
    RegKey='HKEY_CURRENT_USER\\Environment'
    [ "$INIT_FORUSER" = ALL ] && RegKey="HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment"

    RegPath=$(reg query "$RegKey" //v Path 2>/dev/null | tail -2 | head -1 | tr -s ' ' | cut -d " " -f 4-)
    reg add "$RegKey" //v Path //t REG_EXPAND_SZ //d "$RegPath;$("$INIT_REPO/shared/bin/winpath" "$NewPaths")/"
else
    sh "$INIT_REPO/shared/bin/append" "export PATH=\"$NewPaths:\$PATH\"" "$HOME/.profile"
    sh "$INIT_REPO/shared/bin/append" "export PATH=\"$NewPaths:\$PATH\"" "$HOME/.bash_profile"
    sh "$INIT_REPO/shared/bin/append" "export PATH=\"$NewPaths:\$PATH\"" "$HOME/.zprofile"
fi
